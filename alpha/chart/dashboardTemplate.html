<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Load Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Load Chart.js Data Labels plugin from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            padding: 0;
            margin: 0;
        }

        /* Main dashboard layout, statusCard + the two charts */
        main {
            background-color: rgb(230, 230, 230);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            gap: 20px;
        }

        h2 {
            padding-top: 10px;
        }

        .charts-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .pieChart-container {
            width: 280px;
            height: 370px;
        }

        .barChart-container {
            width: 500px;
            height: 370px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* statusCard style */
        .status-cards-container {
            width: 500px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding-bottom: 15px;
        }

        .status-card {
            border-radius: 8px;
            padding: 25px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .card-icon i {
            font-size: 40px;
        }

        .card-content h3 {
            margin: 0;
            font-size: 32px;
            font-weight: bold;
        }

        .card-content p {
            margin: 5px 0 0 0;
            font-size: 16px;
            opacity: 0.9;
        }

        /* coloring the statusCards */
        .card-online {
            background: linear-gradient(135deg, #20bf6b, #26d07c);
        }

        .card-engine {
            background: linear-gradient(135deg, #fa8231, #fc9952);
        }

        .card-ack {
            background: linear-gradient(135deg, #003cff, #3366ff);
        }

        .card-offline {
            background: linear-gradient(135deg, #ff0000, #ff3333);
        }
    </style>
</head>
<body>
    <main>
        <h2>État des véhicules</h2>
        <div class="status-cards-container"></div>
        <div class="charts-container">
            <div class="pieChart-container">
                <canvas id="pieChart"></canvas>
            </div>
            <div class="barChart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </main>
</body>
<script>
    const statusData = {
        "online": {
            label: 'En mouvement',
            value: 85,
            color: '#20bf6b',
            icon: 'fas fa-car-side'
        },
        "engine": {
            label: 'Non confirmé',
            value: 5,
            color: '#fa8231',
            icon: 'fa-solid fa-gear'
        },
        "ack": {
            label: 'À l\'arrêt - Confirmé',
            value: 190,
            color: '#003cff',
            icon: 'fa-solid fa-satellite-dish'
        },
        "offline": {
            label: 'Hors ligne',
            value: 1620,
            color: '#ff0000',
            icon: 'fa-solid fa-ban'
        }
    };

    // Extract status, values, colors, and icons dynamically, so later we just change the statusData to update all charts and cards for a new dashboard
    const status = Object.keys(statusData); // ["online", "engine", "ack", "offline"]
    const dataLabels = Object.values(statusData).map(item => item.label); // ['En mouvement', 'Non confirmé', 'À l\'arrêt - Confirmé', 'Hors ligne']
    const dataValues = Object.values(statusData).map(item => item.value); // [85, 5, 190, 1620]
    const dataColors = Object.values(statusData).map(item => item.color); // ['#20bf6b', '#fa8231', '#003cff', '#ff0000']
    const dataIcons = Object.values(statusData).map(item => item.icon); // ['fa-check-circle', 'fa-cog', 'fa-bell', 'fa-times-circle']

    let myPieChart // store the pie chart instance
    renderPieChart(dataLabels, dataValues, dataColors);

    // Generate status cards dynamically
    const container = document.querySelector('.status-cards-container');
    
    for(let i = 0; i < status.length; i++) {
        const currentStatus = status[i];
        const label = dataLabels[i];
        const count = dataValues[i];
        const icon = dataIcons[i];

        const card = document.createElement('div');
        card.className = `status-card card-${currentStatus}`;
        card.innerHTML = `
            <div class="card-icon">
                <i class="${icon}"></i>
            </div>
            <div class="card-content">
                <h3>${count}</h3>
                <p>${label.charAt(0).toUpperCase() + label.slice(1)}</p> <!-- Capitalize first letter + the rest of the word -->
            </div>
        `;
        container.appendChild(card);
    }

    // Render a Pie Chart
    function renderPieChart(dataLabels, dataValues, dataColors) {
        const ctxPie = document.getElementById('pieChart').getContext('2d');

        // If chart already exists, update data and redraw
        if(myPieChart) {
            myPieChart.data.labels = dataLabels;
            myPieChart.data.datasets[0].data = dataValues;
            myPieChart.data.datasets[0].backgroundColor = dataColors;
            myPieChart.update(); // Triggers re-render
            return;
        }
        
        myPieChart = new Chart(ctxPie, {
            type: 'doughnut', // This can also be 'pie'
            data: {
                labels: dataLabels,
                datasets: [{
                    label: 'Status Count',
                    data: dataValues,
                    backgroundColor: dataColors,
                    borderWidth: 1
                }]
            },
            options: {
                maintainAspectRatio: false, // Allow chart to resize based on container (so it can use thefull containers height when we add paddings to the title and legend)
                layout: {
                    padding: {
                        // Optional: add padding around the chart
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Pourcentage de la flotte par statut',
                        padding: {
                            bottom: 10
                        }
                    },
                    legend: {
                        display: true, // Enable legend for pie charts
                        position: 'bottom', // Optional: position the legend
                        padding: {
                            // only controls spacing between individual legend items, not the gap between the legend box and the chart itself.à
                        }
                    },
                    datalabels: { // Configuration for Data Labels plugin
                        anchor: 'end', // Position at the edge of the slice
                        align: 'end', // Push labels away from the anchor point
                        offset: -4, // Add spacing between slice and label
                        color: '#000',
                        formatter: (value, context) => {
                            // Calculate total of all data points
                            const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            // Calculate percentage
                            const percentage = (value / total * 100);
    
                            if(percentage < 1) {
                                return ''; // Don't display labels who are les than 1%
                            }
    
                            // return the percentage as a string with a '%' sign
                            return percentage.toFixed(1) + '%';
                        }
                    }
                }
            },
            // When we include the Data Labels plugin CDN script, it creates a global variable
            // called "ChartDataLabels" that we need to register with the chart.
            plugins: [ChartDataLabels] // Register the Data Labels plugin
        });
    }

    // Bar Chart
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar', // Specify bar chart type
        data: {
            labels: dataLabels,
            datasets: [{
                label: 'Status Count', // This dataset label is what Chart.js uses when it generates
                // the legend entries and also what appears in tooltips. However, since we have only
                // one dataset, it may not be necessary to display it, so below in
                // "options > plugings" we're hiding the legend.
                data: dataValues,
                backgroundColor: dataColors,
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Répartition des statuts'
                },
                legend: {
                    display: false // Hide legend since we have only one dataset
                }
            },
            scales: {
                y: {
                    beginAtZero: true, // Ensure the y-axis starts at zero
                    title: {
                        display: true,
                        text: 'Nombre de véhicules'
                    }
                }
            }
        }
    });
</script>
</html>