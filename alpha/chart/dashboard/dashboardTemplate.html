<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Load Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Load Chart.js Data Labels plugin from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Load Chart.js Date Adapter plugin from CDN to handle date/time on the x-axis -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <main>
        <h2>État des véhicules</h2>
        <div class="status-cards-container"></div>
        <div class="charts-container-1">
            <div class="pieChart-container">
                <canvas id="pieChart"></canvas>
            </div>
            <div class="barChart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <h2>Aperçu des alertes</h2>
        <div class="charts-container-2">
            <div class="barChartHorizontal-container">
                <canvas id="barChartHorizontal"></canvas>
            </div>
            <div class="lineChart-container">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </main>
</body>

<script src="dashboard-script.js"></script>
<script>
    const statusData = {
        "online": {
            label: 'En mouvement',
            value: 85,
            color: '#20bf6b',
            icon: 'fas fa-car-side'
        },
        "engine": {
            label: 'Non confirmé',
            value: 5,
            color: '#fa8231',
            icon: 'fa-solid fa-gear'
        },
        "ack": {
            label: 'À l\'arrêt - Confirmé',
            value: 190,
            color: '#003cff',
            icon: 'fa-solid fa-satellite-dish'
        },
        "offline": {
            label: 'Hors ligne',
            value: 1620,
            color: '#ff0000',
            icon: 'fa-solid fa-ban'
        }
    };

    const alertsData = [ // similar to "events.data" in the events' index page in ostool, but with only "occurred_at" and "id" properties for simplicity
        {
            "id": 315,
            "type": "distance",
            "occurred_at": "2026-02-05T07:36:07.000000Z"
        },{
            "id": 312,
            "type": "distance",
            "occurred_at": "2026-02-04T07:49:27.000000Z"
        },{
            "id": 314,
            "type": "distance",
            "occurred_at": "2026-02-05T07:52:47.000000Z"
        },{
            "id": 313,
            "type": "distance",
            "occurred_at": "2026-02-04T08:32:27.000000Z"
        },{
            "id": 791,
            "type": "geofence_in",
            "occurred_at": "2026-02-04T08:35:16.000000Z"
        },{
            "id": 311,
            "type": "geofence_in",
            "occurred_at": "2026-02-04T09:14:56.000000Z"
        },{
            "id": 892,
            "type": "geofence_in",
            "occurred_at": "2026-02-04T09:36:16.000000Z"
        },{
            "id": 309,
            "type": "geofence_in",
            "occurred_at": "2026-02-04T10:07:46.000000Z"
        },{
            "id": 310,
            "type": "geofence_in",
            "occurred_at": "2026-02-04T10:09:36.000000Z"
        },{
            "id": 294,
            "type": "geofence_in",
            "occurred_at": "2026-02-04T10:37:06.000000Z"
        },{
            "id": 293,
            "type": "geofence_inout",
            "occurred_at": "2026-02-04T11:36:46.000000Z"
        },{
            "id": 296,
            "type": "geofence_inout",
            "occurred_at": "2026-02-04T11:38:36.000000Z"
        },{
            "id": 299,
            "type": "geofence_out",
            "occurred_at": "2026-02-04T12:13:06.000000Z"
        },{
            "id": 303,
            "type": "geofence_out",
            "occurred_at": "2026-02-04T12:30:56.000000Z"
        },{
            "id": 300,
            "type": "geofence_out",
            "occurred_at": "2026-02-04T14:16:26.000000Z"
        },{
            "id": 304,
            "type": "geofence_out",
            "occurred_at": "2026-02-04T14:33:46.000000Z"
        },{
            "id": 305,
            "type": "geofence_out",
            "occurred_at": "2026-02-04T14:36:46.000000Z"
        },{
            "id": 298,
            "type": "geofence_out",
            "occurred_at": "2026-02-04T15:10:36.000000Z"
        },{
            "id": 297,
            "type": "idle_duration",
            "occurred_at": "2026-02-04T15:20:06.000000Z"
        },{
            "id": 693,
            "type": "idle_duration",
            "occurred_at": "2026-02-04T15:30:16.000000Z"
        },{
            "id": 392,
            "type": "idle_duration",
            "occurred_at": "2026-02-04T15:35:16.000000Z"
        },{
            "id": 591,
            "type": "ignition",
            "occurred_at": "2026-02-04T12:40:16.000000Z"
        },{
            "id": 391,
            "type": "ignition",
            "occurred_at": "2026-02-04T15:45:16.000000Z"
        },{
            "id": 493,
            "type": "ignition",
            "occurred_at": "2026-02-04T15:50:16.000000Z"
        },{
            "id": 492,
            "type": "ignition",
            "occurred_at": "2026-02-04T15:55:16.000000Z"
        },{
            "id": 491,
            "type": "ignition_duration",
            "occurred_at": "2026-02-04T15:59:16.000000Z"
        },{
            "id": 308,
            "type": "ignition_duration",
            "occurred_at": "2026-02-04T16:10:26.000000Z"
        },{
            "id": 307,
            "type": "ignition_duration",
            "occurred_at": "2026-02-04T16:20:36.000000Z"
        },{
            "id": 306,
            "type": "move_duration",
            "occurred_at": "2026-02-04T16:30:26.000000Z"
        },{
            "id": 302,
            "type": "move_duration",
            "occurred_at": "2026-02-04T16:36:56.000000Z"
        },{
            "id": 301,
            "type": "move_duration",
            "occurred_at": "2026-02-05T17:20:06.000000Z"
        },{
            "id": 295,
            "type": "move_duration",
            "occurred_at": "2026-02-04T17:38:06.000000Z"
        }
    ]

    // Extract status, values, colors, and icons dynamically, so later we just change the statusData to update all charts and cards for a new dashboard
    const status = Object.keys(statusData); // ["online", "engine", "ack", "offline"]
    const dataLabels = Object.values(statusData).map(item => item.label); // ['En mouvement', 'Non confirmé', 'À l\'arrêt - Confirmé', 'Hors ligne']
    const dataValues = Object.values(statusData).map(item => item.value); // [85, 5, 190, 1620]
    const dataColors = Object.values(statusData).map(item => item.color); // ['#20bf6b', '#fa8231', '#003cff', '#ff0000']
    const dataIcons = Object.values(statusData).map(item => item.icon); // ['fa-check-circle', 'fa-cog', 'fa-bell', 'fa-times-circle']

    let myPieChart // store the pie chart instance
    renderPieChart(dataLabels, dataValues, dataColors);

    let myBarChart // store the bar chart instance
    renderBarChart(dataLabels, dataValues, dataColors);

    renderStatusCards(status, dataLabels, dataValues, dataIcons);

    // # Horizontal Bar Chart

    const alertsDataTypes = getAlertsDataTypes(alertsData); // e.g. { distance: 4, geofence_in: 6, ... }

    const sortedAlertsDataTypes = sortAlertsDescending(alertsDataTypes); // e.g. { geofence_in: 6, distance: 4, ... }

    // Extract labels and values dynamically
    const alertsLabels = Object.keys(sortedAlertsDataTypes); // ["distance", "geofence_in", "ignition", ...]
    const alertsDataValues = Object.values(sortedAlertsDataTypes); // [6, 4, 2, ...]

    let myBarChartHorizontal // store the horizontal bar chart instance
    renderBarChartHorizontal(alertsLabels, alertsDataValues);

    // # Line Chart

    const alertsDataTime = alertsData.map(item => {
        return {
            occurred_at: item.occurred_at
        };
    });

    const chartData = getAlertsByHour(alertsDataTime);
    // → [{ x: "2026-02-04T12", y: 1 }, { x: "2026-02-04T15", y: 4 }]

    let myLineChart // store the line chart instance
    renderLineChart(chartData);
</script>
</html>